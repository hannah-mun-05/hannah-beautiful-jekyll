---
title: "Visualisation of temporal aspect of the synthetic ART-in-HIV data"
author: "Hannah Mun"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
install.packages("viridis", repo="https://cran.r-project.org/") 
library(dplyr)
library(ggplot2)
library(tidyverse)
library(magrittr) 
library(gridExtra)
library(gganimate)
library(viridis)
```


### Data preparation

```{r echo = TRUE, results='hide', message=FALSE, warning=FALSE}
# load csv file
df <- read_csv("https://figshare.com/ndownloader/files/35249488")

# check missing value
sapply(df, function(x) sum(is.na(x)))

# copy the dataset before making changes
df1 <- df

# remove space and standardize column names
colnames(df1) %<>% str_replace_all(c("\\s"= "_", "-"= "_", "\\."="", "\\("="","\\)"="", "1"="ID"))
colnames(df1)

# change column types accordingly
df1 <- df1 %>%
  # change selected variables to factor variable
  mutate_at(vars(Gender,Ethnic,Base_Drug_Combo,Comp_INI,Comp_NNRTI,Extra_PI), as.factor) %>%
  # change selected variables to logical variable
  mutate_at(vars(Extra_pk_En,VL_M,CD4_M,Drug_M), as.logical) %>%
  # change selected variables to integer variable
  mutate_at(vars(ID,PatientID, Timepoints), as.integer)
```

After pre-processing of the dataset, updated column names and type are saved as 'df1'.

```{r echo=FALSE, message=FALSE, warning=FALSE}
head(df1)
```
There are 8916 patients whose from patients ID 0 to 8915 and each patient has 60 records from timepoints 0 to 59. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
# number of patients who has a same patientID
df1 %>% 
  summarise(min = min(PatientID), max = max(PatientID))

# number of timepoints of each patients
df1 %>%
 group_by(PatientID) %>%
 summarise(dis_tp = n_distinct(Timepoints))

```
  
  
## Visualisation 

According to WHO, treatment goal of HIV is to reduce the viral load in the blood to undetectable levels (less than 50 copies/ml), and the persistent presence of detectable viral load (greater than 1000 copies/ml) in people living with HIV on ART is an indicator of inadequate treatment response and the need to change or adjust the treatment regimen (World Health Organization, 2020).  

As soon as treatment initiated, viral load of both male and female patients started to reduced.Average viral load of male patients at the start of the treatment was over 15000 copies/mL and viral load started to reduced less than 1000 copies/mL after 10th session.
Initial average viral load of female patients were about 500 copies/mL which is much less than male patients and the average viral load of female patients decreased below 1000 copies/mL in a few times of the treatment. Male and female patients remains low level of viral load for the rest of the treatment once it reaches undetectable levels.  

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
# create 2 subsets of dataframe by gender (1=male, 2=female)
df1_m <- subset(df1,Gender==1)
df1_f <- subset(df1,Gender==2)

# calculate average VL of patients at same timepoints in each subset 
df1_m1 <- df1_m %>% 
  group_by(Timepoints) %>%
  summarise(avg=mean(VL))

df1_f1 <- df1_f %>% 
  group_by(Timepoints) %>%
  summarise(avg=mean(VL))

# plot average vl by gender
ggplot() +
  geom_point(data=df1_f1,aes(x=Timepoints, y=avg, colour='Female')) +
  geom_line(data=df1_f1,aes(x=Timepoints, y=avg,colour='Female')) +
  geom_point(data=df1_m1,aes(x=Timepoints, y=avg, colour='Male')) +
  geom_line(data=df1_m1,aes(x=Timepoints, y=avg, colour='Male')) +
  geom_hline(yintercept =1000, linetype='dashed',colour='grey') +
  geom_text(aes(60,1000,label = 'VL=1000',vjust=-0.5), size=3) +
  geom_hline(yintercept =50, linetype='dashed',colour='grey') +
  geom_text(aes(60,50,label = 'VL=50', vjust=-0.5), size=3) +
  geom_smooth(se=FALSE, size=0.5) +
  labs(title = "Average viral load of patients over the treatment",
       x = "Timepoints",
       y = "Average viral load(copies/mL)")
```

The normal range of CD4 count is from 500 to 1500 cells/μL of blood, and it progressively decreases over time in persons who are not receiving or not responding well to ART. If the person’s CD4 cell count falls below 200 cells/μL, their immunity is severely compromised, leaving them susceptible to infections and death (World Health Organization, 2020).

Average CD4 counts for both male and female show a repetitive cycle of increase and decrease during the treatment, however the lowest number of CD4 of both gender gradually increase over the time. The difference of lowest and highest CD4 of female is almost twice bigger than male patient, the lowest range is between 250-400 cells/μL and over 1000 cells/μL at its highest whereas male patients has around 500-800 cells/μL in their range. In other works, women has a higher risk without treatment of HIV, also the treatment work effectively when provided.  

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
# create a subset of male patients that saves average CD4 value of each timepoints
df1_m2 <- df1_m %>% 
  group_by(Timepoints) %>%
  summarise(avg2=mean(CD4))

# create a subset of female patients that saves average CD4 value of each timepoints
df1_f2 <- df1_f %>% 
  group_by(Timepoints) %>%
  summarise(avg2=mean(CD4))

# plot average CD4 by gender
ggplot() +
  geom_point(data=df1_m2,aes(x=Timepoints, y=avg2, colour='Male')) +
  geom_line(data=df1_m2,aes(x=Timepoints, y=avg2,colour='Male')) +
  geom_point(data=df1_f2,aes(x=Timepoints, y=avg2, colour='Female')) +
  geom_line(data=df1_f2,aes(x=Timepoints, y=avg2, colour='Female')) +
  labs(title = "Average CD4 cell counts of patients over the treatment",
       x = "Timepoints",
       y = "Average absolute CD4 (cells/μL)")
```


Below describes the effect of the treatment over time by different ethnicity and gender.

Among male patients, African has the lowest level of viral load compared to Caucasian and other races except Asian at the beginning, and all of races show drastic improvement within 20th session, and viral load of all races sit in the safe area at the end of the treatment. Minimum number of CD4 cells has a cycle of increase and decrease but gradually increase over time for all races, which African male patients has the lowest CD4 cells counted at the beginning but shows the biggest increase when it's improved, following Caucasian and other race.

Among female patients,overall viral load decrease over time however Caucasian shows the highest viral load during the entire time, and seems less improvement of viral load drops to the undetectable level (viral load <50 copies/mL) over the time compared to other races.   


```{r echo=FALSE, warning=FALSE, message=FALSE, fig.height=3, fig.width=10}
#plot average vl and CD4 of male by ethnicity                
m1 <- df1_m %>%
  group_by(Timepoints,Ethnic)  %>%
  summarise(avg=mean(VL)) %>%
  ggplot(aes(x=Timepoints, y=avg, colour=Ethnic)) +
  geom_point() +
  geom_line() +
  labs(x = "Timepoints",
       y = "Average viral load(copies/mL)") +
  theme(legend.position="top") +
  scale_color_discrete(labels =c("African", "Caucasian", "Other"))

m2 <- df1_m %>%
  group_by(Timepoints,Ethnic)  %>%
  summarise(avg=mean(CD4)) %>%
  ggplot(aes(x=Timepoints, y=avg, colour=Ethnic)) +
  geom_line() +
  facet_wrap(vars(Ethnic),labeller = labeller(Ethnic = c("2" = "African", "3" = "Caucasian", "4" = "Other"))) +
  labs(x = "Timepoints",
       y = "Average count of CD4 (cells/μL)") +
  theme(legend.position="none")

#plot average vl and CD4 of female by ethnicity                
f1 <- df1_f %>%
  group_by(Timepoints,Ethnic)  %>%
  summarise(avg=mean(VL)) %>%
  ggplot(aes(x=Timepoints, y=avg, colour=Ethnic)) +
  geom_point() +
  geom_line() +
  labs(x = "Timepoints",
       y = "Average viral load(copies/mL)") +
  theme(legend.position="none")

f2 <- df1_f %>%
  group_by(Timepoints,Ethnic)  %>%
  summarise(avg=mean(CD4)) %>%
  ggplot(aes(x=Timepoints, y=avg, colour=Ethnic)) +
  geom_line() +
  facet_wrap(vars(Ethnic),labeller = labeller(Ethnic = c("2" = "African", "3" = "Caucasian", "4" = "Other"))) +
  labs(x = "Timepoints",
       y = "Average count of CD4 (cells/μL)") +
  theme(legend.position="none")

# layout plots
grid.arrange(m1, m2, ncol=2,widths = c(2/5,3/5), top= "Average viral load and CD4 cell counts of male patients by ethnicity")
grid.arrange(f1, f2, ncol=2,widths = c(2/5,3/5), top= "Average viral load and CD4 cell counts of female patients by ethnicity")
```


Following graphs describe viral load of male and female patient on different base drug combination. Overall, average number of viral load of each time point is decreased over the time. FTC + TDF, 3TC + ABC, DARV + FTC + TDF and other type of combination were applied to the patients whose initial viral load is high. Other type showed the most drastic decrease of viral load following FTC + TDF, 3TC + ABC and DARV + FTC + TDF. It is hard to tell the effect of FTC + TAF and FTC + RTVB + TDF because these were applied to the patients whose initial viral load is lower than other patients therefore the effect is much smaller than other base drug combination. It might be these types of the combinations are only effective to the patients whose symtoms are mild, however other factors should be considered to come up with the conclusion of the effectiveness.

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
# calculate viral load of  male and female by base drug combo
df1_m3 <- df1_m %>%
  group_by(Timepoints,Base_Drug_Combo)  %>%
  summarise(avg=mean(VL))

df1_f3 <- df1_f %>%
  group_by(Timepoints,Base_Drug_Combo)  %>%
  summarise(avg=mean(VL))

# plot calculation
ggplot() +
  geom_line(data =df1_m3,aes(x=Timepoints, y=avg, colour='Male')) +
  geom_line(data =df1_f3,aes(x=Timepoints, y=avg, colour='Female')) +
  facet_wrap(vars(Base_Drug_Combo),
             labeller = labeller(Base_Drug_Combo = c("0" = "FTC + TDF",
                                                     "1" = "3TC + ABC",
                                                     "2" = "FTC + TAF",
                                                     "3" = "DARV + FTC + TDF",
                                                     "4" = "FTC + RTVB + TDF",
                                                     "5" = "Other"))) +
  labs(x = "Timepoints",
       y = "Average viral load(copies/mL)",
       title = "Average viral load of different base drug combination over time")+
  scale_color_discrete(labels =c("Female","Male"))
```


## Animation  


Following graph shows a relation between viral load and CD4 of Caucasian patients over the time. When viral load goes down, CD4 increases. After each treatment, viral load drops quickly and CD4 increased, and CD4 drops again until the next treatment. Over the treatment, average CD4 increases and viral load decreases.

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
p <- df1 %>%
  group_by(Timepoints, Gender, Ethnic == 3) %>%
  summarise(m_vl = mean(VL), m_cd4 = mean(CD4)) %>%
  ggplot(aes(x = Timepoints, y = m_vl, colour = "VL")) +
  geom_line() +
  geom_point() +
  scale_color_viridis(discrete = TRUE) +
  geom_line(aes(x = Timepoints,y = m_cd4 * 10, colour= "CD4")) +
  geom_point() +
  scale_color_viridis(discrete = TRUE) +
  scale_x_discrete(name = "Timepoints") +
  scale_y_continuous(name = "Average viral load (copies/mL)",
                     sec.axis = sec_axis(~ ./10, name ="Average count of CD4 (cells/μL)")) +
  facet_wrap(vars(Gender),nrow=2, labeller = labeller(Gender = c("1" =" Male", "2" = "Female"))) +
  theme(legend.position="top") +
  labs(title = "Change of Viral load and CD4 cell counts of Caucasian patients")

p + transition_reveal(Timepoints) 
```


**Reference**  
World Health Organization. (n.d.). HIV/AIDS. Available from https://www.who.int/health-topics/hiv-aids/#tab=tab_1  




--- End of document ---
 
